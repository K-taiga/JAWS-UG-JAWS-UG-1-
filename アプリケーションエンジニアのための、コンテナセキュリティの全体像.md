# アプリケーションエンジニアのための、コンテナセキュリティの全体像

## イメージの脅威
| 脅威                       | 対策                                                     | 
| -------------------------- | -------------------------------------------------------- | 
| イメージの脆弱性           | ECRのスキャン                                            | 
| イメージ設定の不備         | Dockle                                                   | 
| 埋め込まれたマルウェア     | ClamAVなどのマルウェアスキャン                           | 
| 平文のsecret               | SSMパラメータストアやSecrets manager使う<br>Dockleも検出 | 
| 信頼できないイメージの使用 | AWS Signerなどの署名済みのイメージを使う                 | 

## コンテナレジストリの脅威(ECR)

| 脅威                   | 対策                                                                                       | 
| ---------------------- | ------------------------------------------------------------------------------------------ | 
| レジストリへのアクセス | TLS暗号化                                                                                  | 
| 古いイメージ           | 古いイメージをECRのライフサイクルポリシーで削除する                                        | 
| 不十分な認証           | ・リソースベースのポリシー制御<br>・VPC Endpointのセキュリティグループによってアクセス制御 | 

## コンテナの脅威(ECS)

| 脅威                         | 対策                                                                                                                                 | 
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | 
| コンテナからの無制限アクセス | アウトバウンドで外に持ち出される可能性がある<br>アウトバウンドトラフィックの制御をNACLなどで設定する                                 | 
| コンテナランタイムの設定     | ・コンテナの実行ユーザーをrootにしない<br>・ReadOnlyファイルにする<br>・AWS Config等でセキュアにできているか確認できるように仕組み化 | 

## ホストOSのリスク

・EC2インスタンスの場合は対策が必要！ Fargateの場合は不要！

・EC2の場合はBottlerocketのAMIを使うとアタックサーフェースがなくなりセキュアになる

## アプリケーションエンジニアが意識しないといけない部分

・コンテナイメージの脆弱性については、アプリケーションエンジニアが意識する必要がある

### イメージのスキャン
・ECRのスキャン機能はBasicとEnhancedの2種類がある

→ Enhancedはプログラミング言語レベルのスキャンできる

・Event Bridgeと統合して、スキャン結果で脆弱性が見つかると削除するといったこともできる

### イメージ設定の不備

・ベースイメージには信頼のおけるものを使う

→ Distrolessやalpineなど

→ **マルチステージビルドによってイメージを小さく保つ**

<マルチステージとは>
・ステージを分けてビルドする機能

・最後の段階のイメージのみが最終的な成果物になる

・ビルドに必要なイメージではなく実行に必要なもののみにできる

・hadolintを利用するとDockerfileをベストプラティクスに沿ったlintができる

→ CI/CDに組み込める

### 埋め込まれたマルウェア

・シグネチャベースのマルウェアスキャンを行う

→ 既知のスキャンに対応で未知のものは対応できない

・振る舞いベースのマルウェアスキャンを行う

→ 未知でも振る舞いを見てスキャンができるのでこれと併用をすることが良い

・本番稼働前はシグネチャベースのスキャン、本番稼働後は振る舞いベースのスキャンを行うと良い

### 埋め込められた平文の秘密情報

・Dockleを利用するとDockerfileに平文の秘密情報が埋め込まれていないかを検出できる

### 信頼できないイメージの使用

・コンテナイメージの署名と実行時の署名検証が大事

・AWS Signerを使うと署名の検証ができる

→ AWS Managedなので管理が楽

・ECS自体には署名検証の仕組みがないのでデプロイ時に組み込む(AWS Deploy)

・latestタグでやっているとイメージのスキャン後にコンテナイメージの変更がされる事がある、、、？

・それを避けるにはイメージダイジェストを参照するのがよい